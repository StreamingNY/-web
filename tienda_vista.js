window.productosData = [
    {
    id: 1,
    nombre: "Netflix Premium",
    precio: "12.00",
    precio_oferta: "10.00", // Nuevo campo para precio promocional
    precio_renovacion: "10.00",
    imagen: "productos/NETFLIX_PERFIL.png",
    tipo: "perfil",
        descripcion: `
𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
✔️ PLAN PREMIUN
✔️ FULL ULTRA HD
✔️ 1 PERFIL
✔️ GARANTIA 30 DIAS

𝙎𝙀 𝙀𝙉𝙏𝙍𝙀𝙂𝘼:
🖥️ CORREO
🔐 PASSWORD`,
    categoria: "Peliculas y Series",
    isFeatured: true // Marcado como destacado
    },
    {
        id: 2,
        nombre: "Prime Video",
        precio: "11.00",
        precio_oferta: "10.00", // Nuevo campo para precio promocional
        precio_renovacion: "11.00",
        imagen: "productos/PRIME_VIDEO_PERFIL.png",
        tipo: "perfil",
        descripcion: `
𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
✔️ PLAN PREMIUN
✔️ FULL ULTRA HD
✔️ 1 PERFIL
✔️ GARANTIA 30 DIAS

𝙎𝙀 𝙀𝙉𝙏𝙍𝙀𝙂𝘼:
🖥️ CORREO
🔐 PASSWORD`,
categoria:"Peliculas y Series",
isFeatured: true // Marcado como destacado
    },
    {
        id: 3,
        nombre: "Disney+",
        precio: "13.00",
        precio_oferta: "10.00", // Nuevo campo para precio promocional
        precio_renovacion: "13.00",
        imagen: "productos/DISNEY_PERFIL.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ PLAN PREMIUN
                ✔️ INCLUYE ESPN Y STAR
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS

                𝙎𝙀 𝙀𝙉𝙏𝙍𝙀𝙂𝘼:
                🖥️ CORREO
                🔐 PASSWORD`,
categoria:"Peliculas y Series",
isFeatured: true // Marcado como destacado
    },
    {
        id: 4,
        nombre: "HBO Max",
        precio: "5.00",
        precio_renovacion: "5.00",
        imagen: "productos/MAX_PERFIL.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ PLAN PREMIUN
                ✔️ FULL ULTRA HD
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS

                𝙎𝙀 𝙀𝙉𝙏𝙍𝙀𝙂𝘼:
                🖥️ CORREO
                🔐 PASSWORD`,
categoria:"Peliculas y Series",
isFeatured: false
    },
    {
        id: 5,
        nombre: "Crunchyroll",
        precio: "3.00",
        precio_renovacion: "3.00",
        imagen: "productos/CRUNCHYROLL_PERFIL.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ PLAN MEGA FAN
                ✔️ FULL ULTRA HD
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS

                𝙎𝙀 𝙀𝙉𝙏𝙍𝙀𝙂𝘼:
                🖥️ CORREO
                🔐 PASSWORD`,
categoria:"Anime",
isFeatured: false
    },
        {
        id: 6,
        nombre: "Paramount+",
        precio: "3.00",
        precio_renovacion: "3.00",
        imagen: "productos/PARAMOUNT_PERFIL.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ PLAN PLUS
                ✔️ FULL ULTRA HD
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS

                𝙎𝙀 𝙀𝙉𝙏𝙍𝙀𝙂𝘼:
                🖥️ CORREO
                🔐 PASSWORD`,
categoria:"Peliculas y Series",
isFeatured: false
    },
            {
        id: 7,
        nombre: "Vix Premium",
        precio: "8.00",
        precio_renovacion: "8.00",
        imagen: "productos/vix_perfil.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ PLAN PREMIUM
                ✔️ FULL ULTRA HD
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS

                𝙎𝙀 𝙀𝙉𝙏𝙍𝙀𝙂𝘼:
                🖥️ CORREO
                🔐 PASSWORD`,
categoria:"Peliculas y Series",
isFeatured: false
    },
                {
        id: 8,
        nombre: "Youtube Premium + Music",
        precio: "10.00",
        precio_renovacion: "10.00",
        imagen: "productos/YOUTUBE_INDIVIDUAL.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ A su Correo
                ✔️ Plan Premium
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS
`,
categoria:"Plataformas de Música/video",
isFeatured: false
    },
                    {
        id: 9,
        nombre: "Spotify Music",
        precio: "12.00",
        precio_renovacion: "10.00",
        imagen: "productos/SPOTIFY_INDIVIDUAL.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Plan Premiun
                ✔️ Modo Ofline
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS
`,
categoria:"Plataformas de Música/video",
isFeatured: false
    },

                        {
        id: 10,
        nombre: "Deezer Music",
        precio: "10.00",
        precio_renovacion: "10.00",
        imagen: "productos/DEEZER_PERFIL.png",
        tipo: "perfil",
        descripcion: `Con Deezer Premium puedes escuchar tus canciones favoritas y crear playlists. Puedes incluso identificar canciones o cantar tus canciones favoritas con la letra gracias a funciones como SongCatcher y Letras.
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Plan Premiun
                ✔️ Modo Ofline
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS
`,
categoria:"Plataformas de Música/video",
isFeatured: false
    },

                        {
        id: 11,
        nombre: "Apple Music",
        precio: "10.00",
        precio_renovacion: "10.00",
        imagen: "productos/appemusic_perfil.png",
        tipo: "perfil",
        descripcion: `Apple Music es un servicio de transmisión de música sin anuncios que te permite escuchar millones de canciones y tu biblioteca musical.
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Solo Android
                ✔️ Plan Premiun
                ✔️ Modo Ofline
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS
`,
categoria:"Plataformas de Música/video",
isFeatured: false
    },

                            {
        id: 12,
        nombre: "Tidal Music",
        precio: "10.00",
        precio_renovacion: "10.00",
        imagen: "productos/tidal_perfil.png",
        tipo: "perfil",
        descripcion: `Tidal es un servicio de música de emisión continua basado en suscripción que combina audio sin pérdida y videos musicales de alta definición con una editorial selecta.
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Plan Premiun
                ✔️ Modo Ofline
                ✔️ 1 PERFIL
                ✔️ GARANTIA 30 DIAS
`,
categoria:"Plataformas de Música/video",
isFeatured: false
    },
                        {
        id: 13,
        nombre: "Claro video + Liga 1max",
        precio: "13.00",
        precio_renovacion: "13.00",
        imagen: "productos/clarovideo_perfil.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ TV basica
                ✔️ 1 Dipositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria:["Películas y Series", "Plataformas de TV en Vivo"],
isFeatured: false
    },
                          {
        id: 14,
        nombre: "Directv GO + Liga 1max",
        precio: "28.00",
        precio_renovacion: "28.00",
        imagen: "productos/directvgo_perfil.png",
        tipo: "perfil",
        descripcion: ` ¡Disfruta de lo mejor con DIRECTV GO PLAN ORO + LIGA 1 MAX!
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Plan Premiun
                ✔️ 1 Dipositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria: "Plataformas de TV en Vivo",
isFeatured: false
    },


                              {
        id: 15,
        nombre: "Win Tv + Liga 1max",
        precio: "13.00",
        precio_renovacion: "13.00",
        imagen: "productos/wintv_perfil.png",
        tipo: "perfil",
        descripcion: ` LA ACTIVACIÓN A TV SE REALIZARÁ ÚNICAMENTE MEDIANTE CÓDIGO
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Plan Premiun
                ✔️ 1 Dipositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria: "Plataformas de TV en Vivo",
isFeatured: false
    },
                                  {
        id: 16,
        nombre: "Movistar Play + Gol Perú",
        precio: "20.00",
        precio_renovacion: "20.00",
        imagen: "productos/movistarplay.png",
        tipo: "perfil",
        descripcion: ` LA ACTIVACIÓN A TV SE REALIZARÁ ÚNICAMENTE MEDIANTE CÓDIGO
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Plan Premiun
                ✔️ 1 Dipositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria: "Plataformas de TV en Vivo",
isFeatured: false
    },
                                      {
        id: 17,
        nombre: "L1GA 1 MAX",
        precio: "10.00",
        precio_renovacion: "10.00",
        imagen: "productos/l1max.png",
        tipo: "perfil",
        descripcion: `
𝙄𝙉𝘾𝙇𝙐𝙔𝙀:

✔️ 𝙐𝙇𝙏𝙍𝘼 𝙃𝘿
✔️ 𝙃𝘼𝙎𝙏𝘼 1 𝘿𝙄𝙎𝙋𝙊𝙎𝙄𝙏𝙄𝙑𝙊𝙎 𝙀𝙉 𝙎𝙄𝙈𝙐𝙇𝘼𝙉𝙀𝙊
✔️ 𝘼𝘾𝘾𝙀𝙎𝙊 𝘼 𝘾𝘼𝙉𝘼𝙇 𝙇𝙄𝙂𝘼𝟭 𝙈𝘼𝙓 𝙔 𝘾𝘼𝙉𝘼𝙇 𝙇𝟭

𝙎𝙀 𝙀𝙉𝙏𝙍𝙀𝙂𝘼:

📧 𝘾𝙊𝙍𝙍𝙀𝙊 𝙔 𝘾𝙊𝙉𝙏𝙍𝘼𝙎𝙀Ñ𝘼
🌐 𝙋𝙇𝘼𝙏𝘼𝙁𝙊𝙍𝙈𝘼: https://watch.l1max.com
`,
categoria: "Plataformas de TV en Vivo",
isFeatured: false
    },

                                      {
        id: 18,
        nombre: "Iptv",
        precio: "10.00",
        precio_renovacion: "10.00",
        imagen: "productos/iptv.png",
        tipo: "perfil",
        descripcion: ` 
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ +4000 canales
                ✔️ +10.000 peliculas y series
                ✔️ 1 Dispositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria: "Plataformas de TV en Vivo",
isFeatured: false
    },

                                  {
        id: 19,
        nombre: "Raukuten Viki",
        precio: "8.00",
        precio_renovacion: "8.00",
        imagen: "productos/rakutenviki.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Version Pass Plus
                ✔️ 1 Dispositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria: "Peliculas y Series",
isFeatured: false
    },

                                      {
        id: 20,
        nombre: "Flujo Tv(MagisTV)",
        precio: "12.00",
        precio_renovacion: "12.00",
        imagen: "productos/flujotv.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Plan Premium
                ✔️ 1 Dispositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria: "Plataformas de TV en Vivo",
isFeatured: false
    },

                                          {
        id: 21,
        nombre: "Chat GPT Plus",
        precio: "20.00",
        precio_renovacion: "20.00",
        imagen: "productos/chatgptplus.png",
        tipo: "perfil",
        descripcion: `
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀:
                ✔️ Plan PLus
                ✔️ 1 Dispositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria: "Productividad / Educación",
isFeatured: false
    },
                                              {
        id: 22,
        nombre: "Duolingo",
        precio: "9.00",
        precio_renovacion: "9.00",
        imagen: "productos/duolingoperfil.png",
        tipo: "perfil",
        descripcion: `Debera notifcar su compra anexando el correo que se se encuentra registrado en el app de Doulingo.Tiempo de entrega: El producto llegará a tu purchases en un intervalo de 30 a 60 minutos.
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀: 
                ✔️ Plan Premium
                ✔️ 1 Dispositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria: "Productividad / Educación",
isFeatured: false
    },
                                                  {
        id: 23,
        nombre: "Camva Pro",
        precio: "10.00",
        precio_renovacion: "10.00",
        imagen: "productos/camvapro.png",
        tipo: "perfil",
        descripcion: `Acceso completo a Canva Pro con todas las plantillas premium y funciones exclusivas.
                𝙄𝙉𝘾𝙇𝙐𝙔𝙀: 
                ✔️ A su Correo
                ✔️ Plan Premium
                ✔️ 1 Dispositivo
                ✔️ GARANTIA 30 DIAS
`,
categoria: "Productividad / Educación",
isFeatured: false
    },
                                                      {
        id: 24,
        nombre: "Doxeo",
        precio: "15.00",
        precio_renovacion: "No Renovable",
        imagen: "productos/busqueda.png",
        tipo: "perfil",
        descripcion: `
💡 Con nuestro BOT DE INVESTIGACIÓN AVANZADA, encuentra la verdad sobre cualquier persona de manera fácil y rápida. 🌐
🔍 ¿Qué puedes descubrir?
✅ C4 Azul
✅ C4 Blanco
✅ DNI Virtual Azul
✅ DNI Virtual Amarillo
✅ Actas: Nacimiento, Matrimonio, Defunción
✅ Titularidad de Líneas Telefónicas
✅ Certificado de Inscripción en RENIEC
✅ Trabajos: Antiguos y Actuales
✅ Riesgo Crediticio
✅ Árbol Genealógico
✅ Antecedentes: Policial, Penal, Judicial
✅ Búsqueda de Denuncias
✅ Búsqueda por Nombres y Apellidos
✅ Consulta de Requisitorias
✅ Correos Vinculados a un DNI
✅ Búsqueda de Cónyuge o Familiares por DNI
✅ Direcciones y Propiedades (SUNARP)
(PRECIO VARIA SEGÚN EL TIPO DE INFORMACIÓN SOLICITADA)
`,
categoria: "Investigacion",
isFeatured: false
    },

                                                  {
        id: 25,
        nombre: "SEGUIDORES,LIKES,VIEWS",
        precio: "20.00",
        precio_renovacion: "No Renovable",
        imagen: "productos/seguidores.png",
        tipo: "perfil",
        descripcion: `
        SERVICIOS:
               ✅FACEBOOK: 1K SEGUIDORES O 1K ME GUSTA + 10K VISTAS VIDEO + 10K VISTAS REELS
               ✅PROMOCION PARA ACTIVAR LIVE
               ✅TIKTOK: 1K SEGUIDORES + 100K VISTAS + 1K ME GUSTA
               ✅SEGUIDORES REALES 1K TIKTOK
        (PRECIO VARIA SEGÚN LA SOLICITUD DESEADA)
`,
categoria: "Servicio redes sociales",
isFeatured: false
    },

        {
        id: 26,
        nombre: "Netflix CUENTA COMPLETA",
        precio: "40.00",
        precio_renovacion: "40.00",
        imagen: "productos/NETFLIX_COMPLETA.png",
        tipo: "cuenta",
        descripcion: `𝙄𝙉𝘾𝙇𝙐𝙔𝙀:

✔️ 𝙋𝙇𝘼𝙉 𝙋𝙍𝙀𝙈𝙄𝙐𝙈
✔️ 𝙁𝙐𝙇𝙇 𝙐𝙇𝙏𝙍𝘼 𝙃𝘿
✔️ 𝟱 𝙋𝙀𝙍𝙁𝙄𝙇𝙀𝙎
✔️ 𝟰 𝘿𝙄𝙎𝙋𝙊𝙎𝙄𝙏𝙄𝙑𝙊𝙎 𝙀𝙉 𝙎𝙄𝙈𝙐𝙇𝙏𝘼𝙉𝙀𝙊

𝙎𝙀 𝙀𝙉𝙏𝙍𝙀𝙂𝘼:

🖥️ 𝘾𝙊𝙍𝙍𝙀𝙊
🔐 𝙋𝘼𝙎𝙎𝙒𝙊𝙍𝘿

        `,
categoria: "Peliculas y Series",
isFeatured: false
    },
];


let currentPage = 0;
const productsPerPage = 6;
window.filterState = 0; // 0: All, 1: Perfiles, 2: Cuentas
let renderedProductIds = new Set(); // Track rendered product IDs

// Function to validate product data
function validateProduct(product) {
    const requiredFields = ['id', 'nombre', 'precio', 'precio_renovacion', 'imagen', 'tipo', 'descripcion', 'categoria', 'isFeatured'];
    for (const field of requiredFields) {
        if (!product[field]) {
            console.error(`Producto con ID ${product.id} falta el campo requerido: ${field}`);
            return false;
        }
    }
    if (!['perfil', 'cuenta'].includes(product.tipo)) {
        console.error(`Producto con ID ${product.id} tiene un tipo inválido: ${product.tipo}`);
        return false;
    }
    return true;
}

// Function to sort products
function sortProducts(products) {
    return [...products].sort((a, b) => a.id - b.id);
}

// Create background particles
function createParticles(count) {
    const particlesContainer = document.createElement('div');
    particlesContainer.className = 'floating-particles';
    document.body.appendChild(particlesContainer);
    
    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        particle.style.width = `${2 + Math.random() * 3}px`;
        particle.style.height = particle.style.width;
        particle.style.opacity = `${0.1 + Math.random() * 0.3}`;
        particle.style.animationDuration = `${15 + Math.random() * 30}s`;
        particle.style.animationDelay = `${Math.random() * 5}s`;
        particlesContainer.appendChild(particle);
    }
}

// Setup filter toggle
function setupFilterToggle() {
    const toggle = document.getElementById('stockToggle');
    const textos = document.querySelectorAll('.filter-text');
    
    if (toggle) {
        toggle.checked = window.filterState === 2;
        updateFilterTexts(window.filterState);
        
        toggle.addEventListener('click', () => {
            window.filterState = (window.filterState + 1) % 3;
            toggle.checked = window.filterState === 2;
            updateFilterTexts(window.filterState);
            renderFilteredProducts();
            requestAnimationFrame(() => createRippleEffect(toggle));
        });
    } else {
        console.error("No se encontró el elemento #stockToggle");
    }
}

// Update filter texts
function updateFilterTexts(filterState) {
    const textos = document.querySelectorAll('.filter-text');
    textos.forEach((texto, index) => {
        if (index === filterState) {
            texto.classList.add('active');
        } else {
            texto.classList.remove('active');
        }
    });
}

// Modifica la función generateProductItemHTML para manejar productos destacados
function generateProductItemHTML(producto, isPromotion = false) {
    const hasPromo = isPromotion && producto.isFeatured && producto.precio_oferta;
    
    const priceHTML = hasPromo ? `
        <div class="precio-compra">
            <span class="precio-original-tachado">S/ ${producto.precio}</span>
            <span class="precio-valor-principal promo-price">S/ ${producto.precio_oferta}</span>
        </div>
    ` : `
        <div class="precio-compra">
            <span class="precio-valor-principal">S/ ${producto.precio}</span>
        </div>
    `;

    const renovacionHTML = producto.precio_renovacion === "No Renovable" ? 
        `<div class="precio-renovacion non-renewable">
            <span class="precio-label-renovacion">No Renovable</span>
        </div>` : 
        (producto.precio_renovacion ? `
        <div class="precio-renovacion">
            <span class="precio-label-renovacion">Renovación</span>
            <span class="precio-valor-renovacion">S/ ${producto.precio_renovacion}</span>
        </div>` : '');

    const promoBadge = hasPromo ? `<div class="promo-badge">OFERTA</div>` : '';

    return `
        <div class="producto-item ${hasPromo ? 'producto-destacado' : ''}" data-id="${producto.id}">
            ${promoBadge}
            <div class="producto-front">
                <div class="producto-banner">
                    <img loading="lazy" src="${producto.imagen}" alt="${producto.nombre}">
                </div>
                <div class="producto-content">
                    <h3 class="producto-titulo" data-producto="${producto.nombre}">${producto.nombre}</h3>
                    <div class="producto-precios">
                        ${priceHTML}
                        ${producto.precio_renovacion ? `<div class="precio-separador"></div>` : ''}
                        ${renovacionHTML}
                    </div>
                </div>
            </div>
        </div>`;
}

// Generate HTML for products with section wrappers (initial render or full replacement)
function generateProductsHTML(products, append = false) {
    const perfilesSection = document.getElementById('perfilesSection');
    const cuentasSection = document.getElementById('cuentasSection');
    if (!perfilesSection || !cuentasSection) {
        console.error("No se encontraron las secciones #perfilesSection o #cuentasSection");
        return '';
    }

    const perfiles = products.filter(producto => producto.tipo === 'perfil');
    const cuentas = products.filter(producto => producto.tipo === 'cuenta');

    // If not appending, clear the sections and set up headers
    if (!append) {
        perfilesSection.innerHTML = '';
        cuentasSection.innerHTML = '';
        renderedProductIds.clear(); // Reset the set of rendered IDs

        if (perfiles.length > 0) {
            perfilesSection.innerHTML = `<h2>Perfiles Personales</h2><div class="productos-grid"></div>`;
        } else {
            perfilesSection.innerHTML = '<h2>Perfiles Personales</h2><p>No se encontraron perfiles personales.</p>';
        }

        if (cuentas.length > 0) {
            cuentasSection.innerHTML = `<h2>Cuentas Completas</h2><div class="productos-grid"></div>`;
        } else {
            cuentasSection.innerHTML = '<h2>Cuentas Completas</h2><p>No se encontraron cuentas completas.</p>';
        }
    }

    // Append or set products to the respective grids, avoiding duplicates
    const perfilesGrid = perfilesSection.querySelector('.productos-grid');
    const cuentasGrid = cuentasSection.querySelector('.productos-grid');

    if (perfilesGrid && perfiles.length > 0) {
        const perfilesHTML = perfiles
            .filter(producto => !renderedProductIds.has(producto.id))
            .map(producto => {
                renderedProductIds.add(producto.id);
                return generateProductItemHTML(producto);
            })
            .join('');
        if (perfilesHTML) {
            if (append) {
                perfilesGrid.insertAdjacentHTML('beforeend', perfilesHTML);
            } else {
                perfilesGrid.innerHTML = perfilesHTML;
            }
        }
    }

    if (cuentasGrid && cuentas.length > 0) {
        const cuentasHTML = cuentas
            .filter(producto => !renderedProductIds.has(producto.id))
            .map(producto => {
                renderedProductIds.add(producto.id);
                return generateProductItemHTML(producto);
            })
            .join('');
        if (cuentasHTML) {
            if (append) {
                cuentasGrid.insertAdjacentHTML('beforeend', cuentasHTML);
            } else {
                cuentasGrid.innerHTML = cuentasHTML;
            }
        }
    }

    return '';
}

// Render filtered products with all items initially
function renderFilteredProducts() {
    const container = document.getElementById('productosContainer');
    if (!container) {
        console.error("No se encontró el elemento #productosContainer");
        return;
    }
    
    // Ajustar productos por página según el tamaño de pantalla
    const isMobile = window.innerWidth < 768;
    const productsPerPageAdjusted = isMobile ? 2 : 6;
    
    container.classList.add('filtering');
    
    requestAnimationFrame(() => {
        currentPage = 0;
        
        const validProducts = window.productosData.filter(validateProduct);
        let productosRender;
        if (window.filterState === 0) {
            productosRender = validProducts;
        } else if (window.filterState === 1) {
            productosRender = validProducts.filter(producto => producto.tipo === 'perfil');
        } else {
            productosRender = validProducts.filter(producto => producto.tipo === 'cuenta');
        }
        productosRender = sortProducts(productosRender);
        
        // Render all products initially if "All", otherwise limit to productsPerPage
        const pageProducts = window.filterState === 0 ? 
            productosRender : 
            productosRender.slice(0, productsPerPageAdjusted);
        
        setTimeout(() => {
            generateProductsHTML(pageProducts, false);
            container.style.display = 'flex';
            window.scrollTo(0, 0);
            container.classList.remove('filtering');
            container.removeEventListener('click', handleProductClick);
            container.addEventListener('click', handleProductClick);
            
            // Forzar redibujado en móviles
            if (isMobile) {
                container.style.display = 'none';
                container.offsetHeight; // Trigger reflow
                container.style.display = 'flex';
            }
        }, 50);
    });
}

// Render additional product pages on scroll
function renderProductsPage(page) {
    const container = document.getElementById('productosContainer');
    if (!container) {
        console.error("No se encontró el elemento #productosContainer");
        return;
    }
    
    const validProducts = window.productosData.filter(validateProduct);
    let productosRender;
    if (window.filterState === 0) {
        productosRender = validProducts;
    } else if (window.filterState === 1) {
        productosRender = validProducts.filter(producto => producto.tipo === 'perfil');
    } else {
        productosRender = validProducts.filter(producto => producto.tipo === 'cuenta');
    }
    productosRender = sortProducts(productosRender);
    const startIdx = page * productsPerPage;
    const endIdx = startIdx + productsPerPage;
    const pageProducts = productosRender.slice(startIdx, endIdx);
    
    if (pageProducts.length === 0) return;
    
    generateProductsHTML(pageProducts, true); // Append new products
    currentPage = page;
}

// Load more products on scroll
function checkForNewPage() {
    const lastProductRow = document.querySelector('#productosContainer .producto-item:last-child');
    if (!lastProductRow) return;
    
    const rect = lastProductRow.getBoundingClientRect();
    const isVisible = rect.top < window.innerHeight + 500;
    
    if (isVisible) {
        const nextPage = currentPage + 1;
        const startIdx = nextPage * productsPerPage;
        
        const validProducts = window.productosData.filter(validateProduct);
        let productosRender;
        if (window.filterState === 0) {
            productosRender = validProducts;
        } else if (window.filterState === 1) {
            productosRender = validProducts.filter(producto => producto.tipo === 'perfil');
        } else {
            productosRender = validProducts.filter(producto => producto.tipo === 'cuenta');
        }
        productosRender = sortProducts(productosRender);
        
        // Only render if there are new products to show
        if (startIdx < productosRender.length && renderedProductIds.size < productosRender.length) {
            renderProductsPage(nextPage);
        }
    }
}

// Ripple effect for filter
function createRippleEffect(element) {
    if (window.innerWidth < 480 && !window.matchMedia('(min-device-pixel-ratio: 2)').matches) return;
    
    const container = element.closest('.epic-filter-container');
    if (!container) return;
    
    requestAnimationFrame(() => {
        const ripple = document.createElement('span');
        ripple.className = 'ripple-effect';
        ripple.style.cssText = `
            position: absolute;
            background: rgba(229, 9, 20, 0.2);
            border-radius: 50%;
            width: 100px;
            height: 100px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            will-change: transform, opacity;
            animation: ripple 0.6s ease-out forwards;
            pointer-events: none;
        `;
        container.appendChild(ripple);
        setTimeout(() => {
            if (ripple.parentNode === container) container.removeChild(ripple);
        }, 600);
    });
}

// Handle product clicks
function handleProductClick(e) {
    const productItem = e.target.closest('.producto-item');
    if (!productItem) return;

    const productId = productItem.getAttribute('data-id');
    const product = window.productosData.find(p => p.id == productId);

    if (!product) {
        console.error(`Producto con ID ${productId} no encontrado`);
        return;
    }

    DOM.modalTitle.textContent = product.nombre;
    DOM.modalDescription.textContent = product.descripcion || `Descripción de ${product.nombre}`;
    const phoneNumber = "51961406401";
    // Use precio_oferta if the product is featured and has a promotional price, otherwise use precio
    const priceToUse = product.isFeatured && product.precio_oferta ? product.precio_oferta : product.precio;
    const message = `Estoy interesado en "${product.nombre}", precio S/ ${priceToUse}. Necesito que me brinde el método de pago.`;
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    DOM.buyButton.onclick = () => window.open(whatsappUrl, '_blank');

    DOM.modal.classList.add('active');
}

/**
 * Tienda Vista JavaScript
 * Manages product rendering, filtering, carousel, and modal interactions for the store page.
 * Includes new features: Search Bar, Category Filter, Promotions Section.
 */

const CONFIG = {
    PRODUCTS_PER_PAGE: 6,
    MOBILE_PRODUCTS_PER_PAGE: 2,
    PARTICLE_COUNT: { DESKTOP: 20, MOBILE: 5 },
    SCROLL_THROTTLE: { DESKTOP: 200, MOBILE: 500 },
    CAROUSEL_INTERVAL: 5000,
    FILTER_STATES: ['all', 'perfil', 'cuenta'],
    CAROUSEL_IMAGES: [
        'publicidad/slide1.png',
        'publicidad/slide2.png',
        'publicidad/slide3.png',
        'publicidad/slide4.png',
        'publicidad/slide5.png',
        'publicidad/slide6.png',
        'publicidad/slide7.png',

    ],
};

const state = {
    currentPage: 0,
    filterState: 0, // 0: All, 1: Perfiles, 2: Cuentas
    renderedProductIds: new Set(),
    isMobile: window.innerWidth < 768,
    searchQuery: '',
    selectedCategory: 'all',
};

// Cache DOM elements
const DOM = {
    productosContainer: document.getElementById('productosContainer'),
    perfilesSection: document.getElementById('perfilesSection'),
    cuentasSection: document.getElementById('cuentasSection'),
    promotionsGrid: document.getElementById('promotionsGrid'),
    stockToggle: document.getElementById('stockToggle'),
    filterTexts: document.querySelectorAll('.filter-text'),
    carouselSlides: document.querySelector('.carousel-slides'),
    prevArrow: document.querySelector('.prev-arrow'),
    nextArrow: document.querySelector('.next-arrow'),
    carouselContainer: document.querySelector('.carousel-container'),
    modal: document.getElementById('productModal'),
    modalTitle: document.getElementById('modalProductTitle'),
    modalDescription: document.getElementById('modalProductDescription'),
    buyButton: document.getElementById('buyButton'),
    searchInput: document.getElementById('searchInput'),
    categoryFilter: document.getElementById('categoryFilter'),
};

/**
 * Validates a product object to ensure it has all required fields.
 * @param {Object} product - The product to validate.
 * @returns {boolean} True if valid, false otherwise.
 */
function validateProduct(product) {
    const requiredFields = ['id', 'nombre', 'precio', 'precio_renovacion', 'imagen', 'tipo', 'descripcion', 'categoria', 'isFeatured'];
    for (const field of requiredFields) {
        if (product[field] === undefined || product[field] === null) {
            console.error(`Producto con ID ${product.id} falta el campo requerido: ${field}`);
            return false;
        }
    }
    if (!CONFIG.FILTER_STATES.slice(1).includes(product.tipo)) {
        console.error(`Producto con ID ${product.id} tiene un tipo inválido: ${product.tipo}`);
        return false;
    }
    return true;
}

/**
 * Sorts products by ID.
 * @param {Array} products - Array of products to sort.
 * @returns {Array} Sorted array of products.
 */
function sortProducts(products) {
    return [...products].sort((a, b) => a.id - b.id);
}

/**
 * Generates HTML for a single product item.
 * @param {Object} producto - The product to render.
 * @returns {string} HTML string for the product.
 */
// Modifica la función generateProductItemHTML para manejar productos destacados
function generateProductItemHTML(producto, isPromotion = false) {
    const hasPromo = isPromotion && producto.isFeatured && producto.precio_oferta;
    
    const priceHTML = hasPromo ? `
        <div class="precio-compra">
            <span class="precio-original-tachado">S/ ${producto.precio}</span>
            <span class="precio-valor-principal promo-price">S/ ${producto.precio_oferta}</span>
        </div>
    ` : `
        <div class="precio-compra">
            <span class="precio-valor-principal">S/ ${producto.precio}</span>
        </div>
    `;

    const renovacionHTML = producto.precio_renovacion === "No Renovable" ? 
        `<div class="precio-renovacion non-renewable">
            <span class="precio-label-renovacion">No Renovable</span>
        </div>` : 
        (producto.precio_renovacion ? `
        <div class="precio-renovacion">
            <span class="precio-label-renovacion">Renovación</span>
            <span class="precio-valor-renovacion">S/ ${producto.precio_renovacion}</span>
        </div>` : '');

    const promoBadge = hasPromo ? `<div class="promo-badge">OFERTA</div>` : '';

    return `
        <div class="producto-item ${hasPromo ? 'producto-destacado' : ''}" data-id="${producto.id}">
            ${promoBadge}
            <div class="producto-front">
                <div class="producto-banner">
                    <img loading="lazy" src="${producto.imagen}" alt="${producto.nombre}">
                </div>
                <div class="producto-content">
                    <h3 class="producto-titulo" data-producto="${producto.nombre}">${producto.nombre}</h3>
                    <div class="producto-precios">
                        ${priceHTML}
                        ${producto.precio_renovacion ? `<div class="precio-separador"></div>` : ''}
                        ${renovacionHTML}
                    </div>
                </div>
            </div>
        </div>`;
}

/**
 * Generates HTML for products and organizes them into sections.
 * @param {Array} products - Products to render.
 * @param {boolean} append - Whether to append or replace existing content.
 * @param {string} targetSection - The target section ('main' for perfiles/cuentas, 'promotions').
 */
function generateProductsHTML(products, append = false, targetSection = 'main') {
    if (targetSection === 'main' && (!DOM.perfilesSection || !DOM.cuentasSection)) {
        console.error("Secciones #perfilesSection o #cuentasSection no encontradas");
        return;
    }
    if (targetSection === 'promotions' && !DOM.promotionsGrid) {
        console.error("Sección #promotionsGrid no encontrada");
        return;
    }

    if (targetSection === 'promotions') {
        const promotionsHTML = products.map(p => {
            state.renderedProductIds.add(p.id);
            return generateProductItemHTML(p);
        }).join('');
        if (promotionsHTML) {
            DOM.promotionsGrid.innerHTML = promotionsHTML;
        }
        return;
    }

    const perfiles = products.filter(p => p.tipo === 'perfil');
    const cuentas = products.filter(p => p.tipo === 'cuenta');

    if (!append) {
        DOM.perfilesSection.innerHTML = perfiles.length > 0 ?
            `<h2>Perfiles Personales</h2><div class="productos-grid"></div>` :
            '<h2>Perfiles Personales</h2><p>No se encontraron perfiles personales.</p>';
        DOM.cuentasSection.innerHTML = cuentas.length > 0 ?
            `<h2>Cuentas Completas</h2><div class="productos-grid"></div>` :
            '<h2>Cuentas Completas</h2><p>No se encontraron cuentas completas.</p>';
        state.renderedProductIds.clear();
    }

    const perfilesGrid = DOM.perfilesSection.querySelector('.productos-grid');
    const cuentasGrid = DOM.cuentasSection.querySelector('.productos-grid');

    if (perfilesGrid && perfiles.length > 0) {
        const perfilesHTML = perfiles
            .filter(p => !state.renderedProductIds.has(p.id))
            .map(p => {
                state.renderedProductIds.add(p.id);
                return generateProductItemHTML(p);
            })
            .join('');
        if (perfilesHTML) {
            perfilesGrid.insertAdjacentHTML(append ? 'beforeend' : 'afterbegin', perfilesHTML);
        }
    }

    if (cuentasGrid && cuentas.length > 0) {
        const cuentasHTML = cuentas
            .filter(p => !state.renderedProductIds.has(p.id))
            .map(p => {
                state.renderedProductIds.add(p.id);
                return generateProductItemHTML(p);
            })
            .join('');
        if (cuentasHTML) {
            cuentasGrid.insertAdjacentHTML(append ? 'beforeend' : 'afterbegin', cuentasHTML);
        }
    }
}

/**
 * Filters products based on search query, category, and filter state.
 * @returns {Array} Filtered products.
 */
function applyFilters() {
    let filteredProducts = window.productosData.filter(validateProduct);

    // Apply search filter
    if (state.searchQuery) {
        const query = state.searchQuery.toLowerCase();
        filteredProducts = filteredProducts.filter(p =>
            p.nombre.toLowerCase().includes(query) ||
            p.descripcion.toLowerCase().includes(query)
        );
    }

    // Apply category filter
    if (state.selectedCategory !== 'all') {
        if (state.selectedCategory === 'Mostrar solo perfiles') {
            filteredProducts = filteredProducts.filter(p => p.tipo === 'perfil');
            window.filterState = 1; // Sync with toggle state
        } else if (state.selectedCategory === 'Mostrar cuentas completas') {
            filteredProducts = filteredProducts.filter(p => p.tipo === 'cuenta');
            window.filterState = 2; // Sync with toggle state
        } else {
            filteredProducts = filteredProducts.filter(p => p.categoria === state.selectedCategory);
        }
    }

    // Apply type filter (All, Perfiles, Cuentas) only if not overridden by category
    if (state.selectedCategory === 'all') {
        if (state.filterState === 1) {
            filteredProducts = filteredProducts.filter(p => p.tipo === 'perfil');
        } else if (state.filterState === 2) {
            filteredProducts = filteredProducts.filter(p => p.tipo === 'cuenta');
        }
    }

    return sortProducts(filteredProducts);
}

/**
 * Renders filtered products based on current filters.
 */
function renderFilteredProducts() {
    if (!DOM.productosContainer) {
        console.error("Elemento #productosContainer no encontrado");
        return;
    }

    DOM.productosContainer.classList.add('filtering');
    state.currentPage = 0;

    const productsPerPage = state.isMobile ? CONFIG.MOBILE_PRODUCTS_PER_PAGE : CONFIG.PRODUCTS_PER_PAGE;
    const filteredProducts = applyFilters();
    const pageProducts = state.filterState === 0 && state.selectedCategory === 'all' ? 
        filteredProducts : 
        filteredProducts.slice(0, productsPerPage);

    setTimeout(() => {
        generateProductsHTML(pageProducts, false);
        DOM.productosContainer.style.display = 'flex';
        DOM.productosContainer.classList.remove('filtering');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }, 50);
}

/**
 * Renders the next page of products for infinite scrolling.
 * @param {number} page - The page number to render.
 */
function renderProductsPage(page) {
    if (!DOM.productosContainer) return;

    const productsPerPage = state.isMobile ? CONFIG.MOBILE_PRODUCTS_PER_PAGE : CONFIG.PRODUCTS_PER_PAGE;
    const filteredProducts = applyFilters();
    const startIdx = page * productsPerPage;
    const pageProducts = filteredProducts.slice(startIdx, startIdx + productsPerPage);

    if (pageProducts.length === 0) return;

    generateProductsHTML(pageProducts, true);
    state.currentPage = page;
}

/**
 * Renders featured products in the promotions section.
 */
// Modifica la función renderFeaturedProducts
function renderFeaturedProducts() {
    const featuredProducts = window.productosData.filter(p => validateProduct(p) && p.isFeatured);
    if (featuredProducts.length === 0) {
        DOM.promotionsGrid.parentElement.style.display = 'none';
        return;
    }
    
    // Limitar a 6 productos destacados como máximo
    const limitedFeatured = featuredProducts.slice(0, 6);
    
    // Generar HTML para la sección de promociones
    const promotionsHTML = limitedFeatured.map(p => generateProductItemHTML(p, true)).join('');
    DOM.promotionsGrid.innerHTML = promotionsHTML;
    
    // Mostrar la sección si hay productos
    DOM.promotionsGrid.parentElement.style.display = 'block';
}

/**
 * Checks if more products should be loaded based on scroll position.
 */
function checkForNewPage() {
    const lastProduct = DOM.productosContainer.querySelector('.producto-item:last-child');
    if (!lastProduct) return;

    const rect = lastProduct.getBoundingClientRect();
    if (rect.top < window.innerHeight + 500) {
        const nextPage = state.currentPage + 1;
        const filteredProducts = applyFilters();
        const productsPerPage = state.isMobile ? CONFIG.MOBILE_PRODUCTS_PER_PAGE : CONFIG.PRODUCTS_PER_PAGE;
        if (nextPage * productsPerPage < filteredProducts.length && state.renderedProductIds.size < filteredProducts.length) {
            renderProductsPage(nextPage);
        }
    }
}

/**
 * Creates background particles for visual effect.
 * @param {number} count - Number of particles to create.
 */
function createParticles(count) {
    const particlesContainer = document.createElement('div');
    particlesContainer.className = 'floating-particles';
    document.body.appendChild(particlesContainer);

    for (let i = 0; i < count; i++) {
        const particle = document.createElement('div');
        particle.className = 'particle';
        particle.style.left = `${Math.random() * 100}%`;
        particle.style.top = `${Math.random() * 100}%`;
        const size = 2 + Math.random() * 3;
        particle.style.width = `${size}px`;
        particle.style.height = `${size}px`;
        particle.style.opacity = `${0.1 + Math.random() * 0.3}`;
        particle.style.animationDuration = `${15 + Math.random() * 30}s`;
        particle.style.animationDelay = `${Math.random() * 5}s`;
        particlesContainer.appendChild(particle);
    }
}

/**
 * Sets up the filter toggle functionality.
 */
function setupFilterToggle() {
    if (!DOM.stockToggle || !DOM.filterTexts.length) {
        console.error("Elementos de filtro no encontrados");
        return;
    }

    DOM.stockToggle.checked = state.filterState === 2;
    updateFilterTexts(state.filterState);

    DOM.stockToggle.addEventListener('change', () => {
        state.filterState = (state.filterState + 1) % CONFIG.FILTER_STATES.length;
        DOM.stockToggle.checked = state.filterState === 2;
        updateFilterTexts(state.filterState);
        renderFilteredProducts();
        createRippleEffect(DOM.stockToggle);
    });
}

/**
 * Updates the filter text display based on the current filter state.
 * @param {number} filterState - The current filter state.
 */
function updateFilterTexts(filterState) {
    DOM.filterTexts.forEach((texto, index) => {
        texto.classList.toggle('active', index === filterState);
    });
}

/**
 * Creates a ripple effect for the filter toggle.
 * @param {HTMLElement} element - The toggle element.
 */
function createRippleEffect(element) {
    if (state.isMobile && !window.matchMedia('(min-device-pixel-ratio: 2)').matches) return;

    const container = element.closest('.epic-filter-container');
    if (!container) return;

    const ripple = document.createElement('span');
    ripple.className = 'ripple-effect';
    ripple.style.cssText = `
        position: absolute;
        background: rgba(229, 9, 20, 0.2);
        border-radius: 50%;
        width: 100px;
        height: 100px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%) scale(0);
        animation: ripple 0.6s ease-out forwards;
        pointer-events: none;
    `;
    container.appendChild(ripple);
    setTimeout(() => ripple.remove(), 600);
}

/**
 * Handles product click events to show the modal.
 * @param {Event} e - The click event.
 */
function handleProductClick(e) {
    const productItem = e.target.closest('.producto-item');
    if (!productItem) return;

    const productId = productItem.getAttribute('data-id');
    const product = window.productosData.find(p => p.id == productId);

    if (!product) {
        console.error(`Producto con ID ${productId} no encontrado`);
        return;
    }

    DOM.modalTitle.textContent = product.nombre;
    DOM.modalDescription.textContent = product.descripcion || `Descripción de ${product.nombre}`;
    const phoneNumber = "51961406401";
    // Use precio_oferta if the product is featured and has a promotional price, otherwise use precio
    const priceToUse = product.isFeatured && product.precio_oferta ? product.precio_oferta : product.precio;
    const message = `Estoy interesado en "${product.nombre}", precio S/ ${priceToUse}. Necesito que me brinde el método de pago.`;
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    DOM.buyButton.onclick = () => window.open(whatsappUrl, '_blank');

    DOM.modal.classList.add('active');
}

/**
 * Checks if an image exists.
 * @param {string} url - The image URL.
 * @returns {Promise<boolean>} True if the image exists, false otherwise.
 */
async function imageExists(url) {
    return new Promise(resolve => {
        const img = new Image();
        img.onload = () => resolve(true);
        img.onerror = () => resolve(false);
        img.src = url;
    });
}

/**
 * Sets up the carousel with available images.
 */
async function setupCarousel() {
    if (!DOM.carouselSlides || !DOM.prevArrow || !DOM.nextArrow || !DOM.carouselContainer) {
        console.error("Elementos del carrusel no encontrados");
        return;
    }

    const availableImages = [];
    for (const url of CONFIG.CAROUSEL_IMAGES) {
        if (await imageExists(url)) availableImages.push(url);
    }

    if (availableImages.length === 0) {
        console.warn("No se encontraron imágenes para el carrusel");
        DOM.carouselContainer.style.display = 'none';
        return;
    }

    DOM.carouselSlides.innerHTML = availableImages
        .map((url, index) => `
            <div class="carousel-slide ${index === 0 ? 'active' : ''}">
                <img src="${url}" alt="Publicidad">
            </div>`)
        .join('');

    if (availableImages.length <= 1) {
        DOM.prevArrow.style.display = 'none';
        DOM.nextArrow.style.display = 'none';
        return;
    }

    const slides = DOM.carouselSlides.querySelectorAll('.carousel-slide');
    let currentSlide = 0;
    let slideInterval;

    function goToSlide(index) {
        slides[currentSlide].classList.remove('active');
        slides[index].classList.add('active');
        currentSlide = index;
        DOM.carouselContainer.classList.add('carousel-transitioning');
        setTimeout(() => DOM.carouselContainer.classList.remove('carousel-transitioning'), 800);
    }

    DOM.prevArrow.addEventListener('click', () => {
        goToSlide((currentSlide - 1 + slides.length) % slides.length);
        resetInterval();
    });

    DOM.nextArrow.addEventListener('click', () => {
        goToSlide((currentSlide + 1) % slides.length);
        resetInterval();
    });

    function startInterval() {
        slideInterval = setInterval(() => {
            goToSlide((currentSlide + 1) % slides.length);
        }, CONFIG.CAROUSEL_INTERVAL);
    }

    function resetInterval() {
        clearInterval(slideInterval);
        startInterval();
    }

    startInterval();
    document.addEventListener('visibilitychange', () => {
        if (document.hidden) clearInterval(slideInterval);
        else startInterval();
    });
}

/**
 * Throttles a function to limit its execution rate.
 * @param {Function} func - The function to throttle.
 * @param {number} delay - The throttle delay in milliseconds.
 * @returns {Function} The throttled function.
 */
function throttle(func, delay) {
    let lastCall = 0;
    return (...args) => {
        const now = Date.now();
        if (now - lastCall >= delay) {
            lastCall = now;
            func(...args);
        }
    };
}

/**
 * Sets up the search functionality.
 */
function setupSearch() {
    if (!DOM.searchInput) {
        console.error("Elemento #searchInput no encontrado");
        return;
    }

    DOM.searchInput.addEventListener('input', () => {
        state.searchQuery = DOM.searchInput.value.trim();
        renderFilteredProducts();
    });
}

/**
 * Sets up the category filter functionality.
 */
function setupCategoryFilter() {
    if (!DOM.categoryFilter) {
        console.error("Elemento #categoryFilter no encontrado");
        return;
    }

    DOM.categoryFilter.addEventListener('change', () => {
        state.selectedCategory = DOM.categoryFilter.value;
        if (state.selectedCategory === 'Mostrar solo perfiles') {
            window.filterState = 1;
        } else if (state.selectedCategory === 'Mostrar cuentas completas') {
            window.filterState = 2;
        } else if (state.selectedCategory === 'Todas las Categorías') {
            window.filterState = 0;
        }
        renderFilteredProducts();
    });
}

/**
 * Initializes the page.
 */
function init() {
    console.log("Inicializando Tienda Vista...");
    
    if (!DOM.productosContainer) {
        console.error("Elemento #productosContainer no encontrado. Abortando inicialización.");
        return;
    }

    if (!window.productosData || !Array.isArray(window.productosData)) {
        console.error("window.productosData no está definido o no es un array. Abortando inicialización.");
        return;
    }

    // Setup event listeners
    DOM.productosContainer.addEventListener('click', handleProductClick);
    DOM.promotionsGrid.addEventListener('click', handleProductClick);
    DOM.modal.addEventListener('click', e => {
        if (e.target === DOM.modal) DOM.modal.classList.remove('active');
    });
    window.addEventListener('scroll', throttle(checkForNewPage, state.isMobile ? CONFIG.SCROLL_THROTTLE.MOBILE : CONFIG.SCROLL_THROTTLE.DESKTOP));

    // Initialize components
    setupCarousel();
    setupFilterToggle();
    setupSearch();
    setupCategoryFilter();
    renderFeaturedProducts();
    renderFilteredProducts();
    createParticles(state.isMobile ? CONFIG.PARTICLE_COUNT.MOBILE : CONFIG.PARTICLE_COUNT.DESKTOP);
}

// Start the application
document.addEventListener('DOMContentLoaded', init);